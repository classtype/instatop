<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v4.min.js"></script>
<style>
h1 {font-weight:bold;}
</style>
</head>
<body>
    <div style="text-align:center">
        <h1>За сутки</h1>
        <svg id="chart_minute" width="960" height="350"></svg>
        <h1>За 30 дней</h1>
        <svg id="chart_hour" width="960" height="350"></svg>
        <!--
        <h1>За все время</h1>
        <svg id="chart3" width="960" height="350"></svg>
        -->
    </div>
    <script>
        var Chart = function(chartID, data) {
            var svg = d3.select(chartID);
            var margin = {top: 20, right: 20, bottom: 30, left: 50};
            var width = +svg.attr('width') - margin.left - margin.right;
            var height = +svg.attr('height') - margin.top - margin.bottom;
            var g = svg.append('g').attr('transform', 'translate('+ margin.left +','+ margin.top +')');
            
            var x = d3.scaleTime().rangeRound([0, width]);
            var y = d3.scaleLinear().rangeRound([height, 0]);
            
            var line = d3.line()
                .x(function(d) { return x(d.date); })
                .y(function(d) { return y(d.count); });
                
            x.domain(d3.extent(data, function(d) { return d.date; }));
            y.domain(d3.extent(data, function(d) { return d.count; }));
            
            g.append('g')
                .attr('transform', 'translate(0,'+ height +')')
                .call(d3.axisBottom(x))
                .select('.domain')
                .remove();
                
            g.append('g')
                .call(d3.axisLeft(y))
                .append('text')
                .attr('fill', '#000')
                .attr('transform', 'rotate(-90)')
                .attr('y', 6)
                .attr('dy', '0.71em')
                .attr('text-anchor', 'end')
                .text('Подписчики');
                
            g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', 'steelblue')
                .attr('stroke-linejoin', 'round')
                .attr('stroke-linecap', 'round')
                .attr('stroke-width', 1.5)
                .attr('d', line);
        };
        
        d3.json('/yana_havana', function(err, charts) {
            if (err) throw err;
            for (var t in charts) {
                for (var i = 0; i < charts[t].length; i++) {
                    var date = new Date(charts[t][i].time * 1000);
                    
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    var h = date.getHours();
                    var m = date.getMinutes();
                    
                    month = (month < 10 ? '0'+month : month);
                    h = (h < 10 ? '0'+h : h);
                    m = (m < 10 ? '0'+m : m);
                    
                    charts[t][i].time = year +'-'+ month +'-'+ day +' '+ h +':'+ m;
                }
                
                
                var parse = function(charts) {
                    var data = [];
                    
                    for (var i = 0; i < charts.length; i++) {
                        data.push({
                            date: d3.timeParse('%Y-%m-%d %H:%M')(charts[i].time),
                            count: charts[i].count
                        });
                    }
                    
                    return data;
                };
                
                if (charts[t].length > 1) {
                    Chart('#chart_'+ t, parse(charts[t]));
                }
            }
        });
    </script>
</body>
</html>